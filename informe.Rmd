---
title: "Trabajo 1 - Muestreo y Planificación de Encuestas I"
author: "Matias Bajac - Lucas Pescetto - Andres Vidal"
date: '2023-04-10'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.show = "all")

rm(list = ls())

library(tidyverse)
library(haven)
library(survey)
library(sampling)
library(ggplot2)
library(gridExtra)

set.seed(0)
```

# Preprocesamiento de los datos

```{r data_processing, include=FALSE}
is_nbi_missing <- function(x) x %in% c(8, 9)
is_nbi_var <- function() starts_with("NBI_")
mutate_nbi <- function(x) zap_labels(x) %>% if_else(is_nbi_missing(.), 0, .)
select_nbi <- function(x) select(x, is_nbi_var(), -NBI_CANTIDAD)
has_xo <- function(x) if_else(x$HOGCE09 == 0, 1, 0)
has_nbi <- function(x) if_else(x$NBI_TOTAL >= 4, 1, 0)

load("datos.RData")
data <- rio_branco %>%
  mutate(across(is_nbi_var(), ~ mutate_nbi(.))) %>%
  mutate(NBI_TOTAL = rowSums(select_nbi(.)), XO = has_xo(.)) %>%
  mutate(NBI = has_nbi(.)) %>%
  filter(!duplicated(ID_VIVIENDA)) %>%
  select(nbi = NBI, xo = XO)

t_nbi <- sum(data$nbi)
t_xo <- sum(data$xo)

N <- nrow(data)
```


# Distribución empírica del estimador

## Funciones Auxiliares

```{r auxiliar}
estimate_total <- function(var, design) {
  svytotal(as.formula(paste0("~", var)), design, deff = TRUE)
}

estimate_totals <- function(var, design_list) {
  lapply(design_list, function(design) estimate_total(var, design))
}

show_results <- function(var, named_result_list) {
  as.data.frame(t(named_result_list), row.names = var)
}
```



## Muestreo del estimador

```{r estimate_dist_sample}
sample_t_estimate <- function(var, sample_size, get_sample, get_design) {
  n_simulations <- 2000

  replicate(n_simulations, {
    sample <- get_sample(sample_size)
    design <- get_design(sample)
    coef(estimate_total(var, design))
  })
}
```

```{r estimate_dist_plots, include=FALSE}
empirical_distribution_sir <-
  function(var, sample_sizes, get_sample, get_design) {
    plots <- lapply(sample_sizes, function(sample_size) {
      # Simular
      t <- data.frame(
        estimate = sample_t_estimate(var, sample_size, get_sample, get_design)
      )

      # Guardar cuantiles
      assign(
        paste0("t_n", sample_size, "_", var, "_quantile"),
        quantile(t$estimate, c(0.025, 0.975)),
        envir = .GlobalEnv
      )

      # Regla de Scott para el ancho de los bins
      binwidth <- 3.5 * sd(t$estimate) / (sample_size^(1 / 3))

      # Graficar Histograma + Curva de densidad
      ggplot(t, aes(x = estimate, y = after_stat(density))) +
        geom_histogram(binwidth = binwidth, color = "black", fill = "white") +
        geom_density(alpha = 0.2, fill = "blue") +
        geom_vline(
          aes(xintercept = get(paste0("t_", var))),
          color = "red",
          linewidth = 1
        ) +
        labs(x = var, y = "Density") +
        theme_classic()
    })
    grid.arrange(grobs = plots, padding = 5)
  }
```


# Diseño de muestreo SIR

## Definición del diseño

```{r sir_design}
get_sir_design <- function(sample) {
  svydesign(
    ids = ~1,
    data = sample,
    probs = 1 - (1 - 1 / N)^nrow(sample),
  )
}
```

## Algoritmo de selección

```{r sir_sampling}
get_sir_sample <- function(sample_size) {
  index <- srswr(sample_size, N)
  getdata(data, index)
}
```

## Obtener muestras finales
```{r sir_samples}
sample_sizes <- c(150, 600, 1000)
sir_samples <- lapply(sample_sizes, get_sir_sample)
names(sir_samples) <- sample_sizes
```

## Obtener objetos de diseño finales

```{r sir_designs}
sir_designs <- lapply(sir_samples, get_sir_design)
```

## Análisis de NBI

### Distribución empírica del estimador para el total de NBI

```{r sir_nbi_estimate_dist, echo=FALSE, results='show'}
empirical_distribution_sir(
  "nbi",
  sample_sizes,
  get_sir_sample,
  get_sir_design
)
```

### Estimación puntual del total de NBI

```{r sir_nbi_estimate}
t_nbi_estimates <- estimate_totals("nbi", sir_designs)
show_results("nbi", t_nbi_estimates)
```

### Efecto diseño del estimador para el total de NBI

```{r sir_nbi_estimate_deff}
t_nbi_estimates_deff <- lapply(t_nbi_estimates, deff)
show_results("nbi", t_nbi_estimates)
```


## Análisis de XO

### Distribución empírica del estimador para el total de XO

```{r sir_xo_estimate_dist, echo=FALSE, results='show'}
empirical_distribution_sir(
  "xo",
  sample_sizes,
  get_sir_sample,
  get_sir_design
)
```

